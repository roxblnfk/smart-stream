# Как это работает

При правильной интеграции пакета в ваш проект вы сможете возвращать из экшенов (методов контроллера) практически любые
данные, которые впоследствии будут автоматически помещены в соответствующий PSR-совместимый Stream и затем в Response.

Например, если экшен вернёт строку, объект `\SplFileInfo` или ресурс, то для создания PRS-Stream
будет использована фабрика `StreamFactory` пакета, которая настроена в проекте в качестве PSR-17.
Если экшен вернёт генератор, то он будет помещён в `GeneratorStream`.
Любые другие данные будут помещены в сущность базового класса `DataBucket` (если это уже не объект класса `DataBucket`),
а затем в `BucketStream`. Так работает фабрика `SmartStreamFactory`.

## DataBucket

Класс `DataBucket` (корзина данных) требуется для хранения и передачи ваших данных в сопровождении параметров,
касающихся этих данных и конвертера, которым эти данные будут переведены в нужный формат.

`DataBucket` хорошо расширяется. Из коробки уже доступны следующие расширения:
`FileBucket`, `RdirectBucket`, `WebTemplatebucket`.

## BucketStream

Все объекты `DataBucket` в фабрике `SmartStreamFactory` попадают в PSR-17 совместимый поток `BucketStream`.
В нём же и происходит конвертирование данных в соответствующий формат, которое начинается при первой попытке чтения
из потока.

В некоторых случаях `BucketStream` может быть нечитаемым, когда является контейнером для неконвертируемого `DataBucket`.
Распакует такие потоки `BucketStreamMiddleware`.

## BucketStreamMiddleware

Все классы `DataBucket` могут содержать информацию о том, какой HTTP статус должен быть у ответа
и с какими HTTP-заголовками. Для применения этой информации на объект `ResponseInterface` используется
`BucketStreamMiddleware`.

Кроме того, `BucketStreamMiddleware` преобразует нечитаемые потоки с неконвертируемыми `DataBucket`
(например, `FileBucket`) в читаемые при помощи настроенной по умолчанию PSR-17 `StreamFactory`.

### Преимущества при работе с DataBucket

#### 1. Методы контроллера проще тестировать

Вы можете сверять не текст, изъятый из объекта `ResponseInterface`, как результат преобразования данных, а сами данные.

#### 2. Простота в использовании

`FileBucket`, `RedirectBucket` и любые другие корзины заточены на удобство использования.
Конкретно `FileBucket` и `RedirectBucket` похожи на аналогичные реализации `ResponseInterface` в некоторых сторонних
пакетах, однако корзины легко расширяются и могут не ориентироваться на HTTP-составляющую.
Например класс `WebTemplateBucket` нацелен на конфигурирование шаблонизатора.

#### 3. Гибкость при настройке форматов

Пример: создаём новый класс корзины `ApiBucket` и настраиваем его на два формата: JSON и XML. При написании кода экшена
нас мало интересует то, в каком формате клиент получит данные, мы просто возвращаем их размещёнными в `ApiBucket`.
Что дальше?

- Мы можем указать формат с помощью middleware `SetFormat`, размещённой на маршруте, группе маршрутов или в общем
  пайплайне.
- Формат выберется автоматически на основе предпочтений клиента.
